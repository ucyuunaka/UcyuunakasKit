# 刷新系统重构 - 任务清单

## 第一阶段：创建新的状态管理基础设施

### 任务 1.1: 实现统一状态管理类
- [ ] 在 `core/` 目录下创建 `file_state_manager.py`
- [ ] 实现 `FileStateManager` 类，包含以下方法：
  - `add_change(path: str, change_type: str)` - 添加文件变化
  - `get_and_clear_changes()` - 获取并清除变化
  - `has_changes()` - 检查是否有待处理变化
  - `get_change_count()` - 获取变化数量
- [ ] 添加线程安全保护机制
- [ ] 编写单元测试验证功能正确性

### 任务 1.2: 实现统一防抖机制
- [ ] 在 `utils/` 目录下创建 `debouncer.py`
- [ ] 实现 `SimpleDebouncer` 类，支持：
  - 可配置的防抖时间（默认300ms）
  - 自动取消重复的定时器
  - 线程安全的调用机制
- [ ] 添加错误处理和资源清理
- [ ] 编写单元测试验证防抖逻辑

### 任务 1.3: 基础设施集成测试
- [ ] 创建集成测试验证状态管理和防抖机制
- [ ] 测试并发场景下的线程安全性
- [ ] 验证内存泄漏和资源清理
- [ ] 性能基准测试

## 第二阶段：重构文件监控模块

### 任务 2.1: 修改 FileWatcher 使用统一防抖
- [ ] 修改 `core/file_watcher.py`，移除内置防抖逻辑
- [ ] 集成 `SimpleDebouncer` 类，设置防抖时间为300ms
- [ ] 更新 `FileChangeHandler` 类使用新的防抖机制
- [ ] 移除 `last_modified` 字典和相关逻辑
- [ ] 测试文件变化检测的准确性

### 任务 2.2: 增强文件监控错误处理
- [ ] 替换 `print(f"监控目录失败 {dir_path}: {e}")` 为用户可见的错误消息
- [ ] 添加监控启动失败的降级处理
- [ ] 实现监控状态检查机制
- [ ] 提供用户手动重新启动监控的功能
- [ ] 更新相关文档和错误消息

### 任务 2.3: 集成新的状态管理
- [ ] 修改 `FileWatcher` 使用 `FileStateManager`
- [ ] 更新回调接口传递状态管理器实例
- [ ] 测试状态管理的完整流程
- [ ] 验证文件变化的准确记录和处理

## 第三阶段：简化应用层通知系统

### 任务 3.1: 移除复杂的通知栏UI
- [ ] 从 `ui/app.py` 中移除 `_create_notification_bar()` 方法
- [ ] 删除 `notification_bar` 和 `notification_label` 相关代码
- [ ] 移除 `_close_notification()` 方法
- [ ] 清理相关的UI布局代码

### 任务 3.2: 简化文件变化通知逻辑
- [ ] 重写 `_on_file_changed()` 方法使用 `FileStateManager`
- [ ] 移除 `modified_files` 和 `deleted_files` 集合
- [ ] 删除 `_show_file_change_notification()` 方法
- [ ] 更新文件变化处理逻辑

### 任务 3.3: 使用状态栏显示文件变化消息
- [ ] 修改文件变化处理使用 `status_bar.show_message()`
- [ ] 设计简洁的文件变化消息格式
- [ ] 实现批量变化消息的合并显示
- [ ] 添加用户友好的操作提示

## 第四阶段：重构刷新操作逻辑

### 任务 4.1: 简化文件刷新操作
- [ ] 重写 `_refresh_changed_files()` 方法
- [ ] 使用 `FileStateManager.get_and_clear_changes()` 获取变化
- [ ] 优化文件信息更新和缓存刷新逻辑
- [ ] 添加刷新进度指示

### 任务 4.2: 更新状态栏统计机制
- [ ] 修改 `_update_status_bar_stats()` 方法
- [ ] 确保统计信息与文件状态同步
- [ ] 优化统计信息的计算和缓存
- [ ] 测试统计信息的准确性和性能

### 任务 4.3: 优化UI更新防抖
- [ ] 统一所有UI更新使用 `UI_UPDATE_DEBOUNCE` 常量（300ms）
- [ ] 移除重复的防抖实现
- [ ] 确保状态栏和文件列表的同步更新
- [ ] 测试UI响应性能

## 第五阶段：清理和优化

### 任务 5.1: 清理废弃代码和注释
- [ ] 移除所有不再使用的方法和变量
- [ ] 更新类和方法的文档字符串
- [ ] 清理过时的注释和TODO标记
- [ ] 统一代码风格和命名规范

### 任务 5.2: 优化组件接口
- [ ] 简化组件间的直接依赖
- [ ] 提取公共接口和常量
- [ ] 优化方法参数和返回值
- [ ] 提升代码的可测试性

### 任务 5.3: 性能优化和测试
- [ ] 分析重构后的性能表现
- [ ] 优化关键路径的执行效率
- [ ] 验证内存使用和泄漏问题
- [ ] 进行压力测试和边界条件测试

## 第六阶段：测试和验证

### 任务 6.1: 单元测试
- [ ] 为 `FileStateManager` 编写完整单元测试
- [ ] 为 `SimpleDebouncer` 编写防抖逻辑测试
- [ ] 测试文件监控功能的正确性
- [ ] 验证错误处理和边界条件

### 任务 6.2: 集成测试
- [ ] 测试完整的文件变化检测和处理流程
- [ ] 验证UI更新和状态同步
- [ ] 测试多种文件操作场景（添加、删除、修改）
- [ ] 验证并发和冲突处理

### 任务 6.3: 用户场景测试
- [ ] 测试拖放文件的自动检测
- [ ] 测试大量文件场景下的性能
- [ ] 验证网络驱动器和特殊文件类型
- [ ] 测试应用启动和关闭的资源清理

## 第七阶段：文档和发布

### 任务 7.1: 更新技术文档
- [ ] 更新相关类的文档字符串
- [ ] 添加新组件的使用示例
- [ ] 更新架构图和设计文档
- [ ] 编写迁移指南和变更日志

### 任务 7.2: 用户文档更新
- [ ] 如有UI变化，更新用户手册
- [ ] 记录性能改进和用户体验优化
- [ ] 准备发布说明和亮点介绍
- [ ] 更新FAQ和故障排除指南

## 依赖关系

```
1.1 -> 1.2 -> 1.3
   \-> 2.1 -> 2.2 -> 2.3
      \-> 3.1 -> 3.2 -> 3.3
         \-> 4.1 -> 4.2 -> 4.3
            \-> 5.1 -> 5.2 -> 5.3
               \-> 6.1 -> 6.2 -> 6.3
                  \-> 7.1 -> 7.2
```

## 风险缓解

- **功能回归风险**：每个阶段都进行充分测试，保持原有功能不变
- **性能影响风险**：持续监控性能指标，确保重构不影响响应速度
- **用户体验风险**：保持消息和反馈的一致性，避免用户困惑
- **代码冲突风险**：小步提交，频繁集成，及时处理冲突

## 完成标准

- [ ] 所有文件变化状态通过 `FileStateManager` 统一管理
- [ ] 复杂的通知栏UI组件已完全移除
- [ ] 所有防抖时间统一为300ms
- [ ] 提供用户可见的错误反馈和功能降级
- [ ] 所有单元测试和集成测试通过
- [ ] 性能测试显示无明显回归
- [ ] 代码审查通过，符合项目规范
- [ ] 文档已完整更新
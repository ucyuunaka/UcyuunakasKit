# Code2Markdown - Material Design 重构版

我为你重构了整个应用，采用 **Material Design 3** 设计理念，并进行了完整的模块化拆分。

## 📁 新的项目结构

```
code2markdown/
├── main.py                      # 应用入口
├── config/
│   ├── __init__.py
│   ├── settings.py              # 配置管理
│   └── theme.py                 # Material Design 主题
├── core/
│   ├── __init__.py
│   ├── file_handler.py          # 文件处理核心
│   └── converter.py             # 转换逻辑
├── ui/
│   ├── __init__.py
│   ├── app.py                   # 主应用窗口
│   ├── components/
│   │   ├── __init__.py
│   │   ├── file_list_panel.py   # 文件列表面板
│   │   ├── control_panel.py     # 控制面板
│   │   └── dialogs.py           # 各种对话框
│   └── widgets/
│       ├── __init__.py
│       └── material_card.py     # Material 卡片组件
└── utils/
    ├── __init__.py
    └── helpers.py               # 辅助函数
```

## 💾 完整代码

### 1. `main.py` - 应用入口

```python
"""
Code2Markdown - Material Design 3
现代化代码转Markdown工具
"""

import customtkinter as ctk
from ui.app import MaterialApp

def main():
    """应用入口"""
    ctk.set_appearance_mode("dark")
    ctk.set_default_color_theme("blue")
    
    app = MaterialApp()
    app.mainloop()

if __name__ == "__main__":
    main()
```

### 2. `config/theme.py` - Material Design 主题

```python
"""
Material Design 3 主题配置
基于 Material You 设计系统
"""

class MaterialTheme:
    """Material Design 3 颜色系统"""
    
    # 主色调 - 紫蓝色系
    PRIMARY = "#6750A4"
    PRIMARY_CONTAINER = "#EADDFF"
    ON_PRIMARY = "#FFFFFF"
    ON_PRIMARY_CONTAINER = "#21005E"
    
    # 次要色 - 粉紫色系
    SECONDARY = "#625B71"
    SECONDARY_CONTAINER = "#E8DEF8"
    ON_SECONDARY = "#FFFFFF"
    ON_SECONDARY_CONTAINER = "#1E192B"
    
    # 第三色 - 暖红色系
    TERTIARY = "#7D5260"
    TERTIARY_CONTAINER = "#FFD8E4"
    ON_TERTIARY = "#FFFFFF"
    ON_TERTIARY_CONTAINER = "#370B1E"
    
    # 错误色
    ERROR = "#BA1A1A"
    ERROR_CONTAINER = "#FFDAD6"
    ON_ERROR = "#FFFFFF"
    ON_ERROR_CONTAINER = "#410002"
    
    # 背景色 - 深色主题
    BACKGROUND = "#1C1B1F"
    ON_BACKGROUND = "#E6E1E5"
    
    # 表面色
    SURFACE = "#1C1B1F"
    SURFACE_1 = "#2B2930"  # 高程1
    SURFACE_2 = "#322F37"  # 高程2
    SURFACE_3 = "#38353E"  # 高程3
    SURFACE_4 = "#3A3740"  # 高程4
    SURFACE_5 = "#403D46"  # 高程5
    
    ON_SURFACE = "#E6E1E5"
    ON_SURFACE_VARIANT = "#CAC4D0"
    
    # 轮廓色
    OUTLINE = "#938F99"
    OUTLINE_VARIANT = "#49454F"
    
    # 成功色（扩展）
    SUCCESS = "#4CAF50"
    SUCCESS_CONTAINER = "#C8E6C9"
    
    # 警告色（扩展）
    WARNING = "#FF9800"
    WARNING_CONTAINER = "#FFE0B2"
    
    # 信息色（扩展）
    INFO = "#2196F3"
    INFO_CONTAINER = "#BBDEFB"
    
    # 字体
    FONT_FAMILY = "Segoe UI Variable"
    FONT_DISPLAY = (FONT_FAMILY, 28, "bold")
    FONT_HEADLINE = (FONT_FAMILY, 24, "bold")
    FONT_TITLE = (FONT_FAMILY, 16, "bold")
    FONT_BODY_LARGE = (FONT_FAMILY, 14)
    FONT_BODY = (FONT_FAMILY, 12)
    FONT_LABEL = (FONT_FAMILY, 11)
    FONT_MONO = ("Consolas", 11)
    
    # 圆角
    RADIUS_SMALL = 8
    RADIUS_MEDIUM = 12
    RADIUS_LARGE = 16
    RADIUS_XLARGE = 28
    
    # 间距
    SPACING_XS = 4
    SPACING_SM = 8
    SPACING_MD = 16
    SPACING_LG = 24
    SPACING_XL = 32
    
    # 阴影（模拟）
    SHADOW_COLOR = "#00000040"

# 快捷访问
MD = MaterialTheme
```

### 3. `config/settings.py` - 配置管理

```python
"""
应用配置管理
"""

import json
import os
from typing import Dict, Any

class Settings:
    """配置管理器"""
    
    def __init__(self, config_file: str = "config.json"):
        self.config_file = config_file
        self.config: Dict[str, Any] = {}
        self.load()
    
    def load(self):
        """加载配置"""
        if not os.path.exists(self.config_file):
            self.config = self._default_config()
            self.save()
            return
        
        try:
            with open(self.config_file, 'r', encoding='utf-8') as f:
                self.config = json.load(f)
        except Exception as e:
            print(f"加载配置失败: {e}")
            self.config = self._default_config()
    
    def save(self):
        """保存配置"""
        try:
            with open(self.config_file, 'w', encoding='utf-8') as f:
                json.dump(self.config, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"保存配置失败: {e}")
    
    def get(self, key: str, default=None):
        """获取配置项"""
        return self.config.get(key, default)
    
    def set(self, key: str, value: Any):
        """设置配置项"""
        self.config[key] = value
    
    def _default_config(self) -> Dict[str, Any]:
        """默认配置"""
        return {
            "window": {
                "width": 1280,
                "height": 800,
                "min_width": 1000,
                "min_height": 600
            },
            "template": "默认",
            "recent_files": [],
            "max_recent_files": 50,
            "auto_save_config": True,
            "preview_max_files": 5
        }
```

### 4. `core/file_handler.py` - 文件处理核心

```python
"""
文件处理核心模块
"""

import os
from typing import List, Dict, Optional
from dataclasses import dataclass

# 支持的语言和扩展名
LANGUAGE_EXTENSIONS = {
    'Python': ['.py', '.pyw', '.pyi'],
    'JavaScript': ['.js', '.jsx', '.mjs'],
    'TypeScript': ['.ts', '.tsx'],
    'Java': ['.java'],
    'C': ['.c', '.h'],
    'C++': ['.cpp', '.hpp', '.cc', '.cxx'],
    'C#': ['.cs'],
    'PHP': ['.php'],
    'Ruby': ['.rb'],
    'Go': ['.go'],
    'Rust': ['.rs'],
    'Swift': ['.swift'],
    'Kotlin': ['.kt', '.kts'],
    'HTML': ['.html', '.htm'],
    'CSS': ['.css', '.scss', '.sass', '.less'],
    'SQL': ['.sql'],
    'Shell': ['.sh', '.bash', '.zsh'],
    'PowerShell': ['.ps1'],
    'YAML': ['.yml', '.yaml'],
    'JSON': ['.json'],
    'XML': ['.xml'],
    'Markdown': ['.md'],
    'Vue': ['.vue'],
    'Svelte': ['.svelte'],
    'Dart': ['.dart'],
    'R': ['.r', '.R'],
    'Lua': ['.lua'],
    'Perl': ['.pl', '.pm'],
    'Text': ['.txt']
}

@dataclass
class FileInfo:
    """文件信息数据类"""
    path: str
    marked: bool = True
    
    @property
    def name(self) -> str:
        return os.path.basename(self.path)
    
    @property
    def language(self) -> str:
        return get_language(self.path)
    
    @property
    def size(self) -> int:
        try:
            return os.path.getsize(self.path)
        except:
            return 0
    
    @property
    def exists(self) -> bool:
        return os.path.exists(self.path)

class FileHandler:
    """文件处理器"""
    
    def __init__(self):
        self.files: List[FileInfo] = []
    
    def add_file(self, path: str) -> bool:
        """添加单个文件"""
        if not os.path.isfile(path):
            return False
        
        # 检查是否已存在
        if any(f.path == path for f in self.files):
            return False
        
        self.files.append(FileInfo(path=path, marked=True))
        return True
    
    def add_files(self, paths: List[str]) -> int:
        """批量添加文件"""
        count = 0
        for path in paths:
            if self.add_file(path):
                count += 1
        return count
    
    def add_folder(self, folder_path: str, recursive: bool = True) -> int:
        """添加文件夹中的所有支持文件"""
        if not os.path.isdir(folder_path):
            return 0
        
        files = scan_folder(folder_path, recursive)
        return self.add_files(files)
    
    def remove_file(self, path: str) -> bool:
        """移除文件"""
        for i, file in enumerate(self.files):
            if file.path == path:
                self.files.pop(i)
                return True
        return False
    
    def clear(self):
        """清空所有文件"""
        self.files.clear()
    
    def toggle_mark(self, path: str) -> bool:
        """切换文件标记状态"""
        for file in self.files:
            if file.path == path:
                file.marked = not file.marked
                return file.marked
        return False
    
    def mark_all(self, marked: bool = True):
        """标记/取消标记所有文件"""
        for file in self.files:
            file.marked = marked
    
    def get_marked_files(self) -> List[FileInfo]:
        """获取所有已标记的文件"""
        return [f for f in self.files if f.marked]
    
    def get_stats(self) -> Dict:
        """获取统计信息"""
        total = len(self.files)
        marked = len(self.get_marked_files())
        total_size = sum(f.size for f in self.files)
        languages = set(f.language for f in self.files)
        
        return {
            'total': total,
            'marked': marked,
            'size': total_size,
            'languages': len(languages)
        }
    
    def filter_files(self, 
                    search: Optional[str] = None,
                    language: Optional[str] = None) -> List[FileInfo]:
        """筛选文件"""
        result = self.files
        
        if search:
            search = search.lower()
            result = [f for f in result if search in f.name.lower()]
        
        if language and language != "全部语言":
            result = [f for f in result if f.language == language]
        
        return result

def get_language(file_path: str) -> str:
    """根据文件扩展名获取编程语言"""
    _, ext = os.path.splitext(file_path.lower())
    
    for language, extensions in LANGUAGE_EXTENSIONS.items():
        if ext in extensions:
            return language
    
    return "Text"

def get_all_languages() -> List[str]:
    """获取所有支持的语言"""
    return sorted(LANGUAGE_EXTENSIONS.keys())

def scan_folder(folder_path: str, recursive: bool = True) -> List[str]:
    """扫描文件夹获取所有支持的文件"""
    supported_files = []
    all_extensions = [ext for exts in LANGUAGE_EXTENSIONS.values() for ext in exts]
    
    if recursive:
        for root, _, files in os.walk(folder_path):
            for file in files:
                file_path = os.path.join(root, file)
                _, ext = os.path.splitext(file_path.lower())
                if ext in all_extensions:
                    supported_files.append(file_path)
    else:
        for file in os.listdir(folder_path):
            file_path = os.path.join(folder_path, file)
            if os.path.isfile(file_path):
                _, ext = os.path.splitext(file_path.lower())
                if ext in all_extensions:
                    supported_files.append(file_path)
    
    return supported_files

def format_size(size_bytes: int) -> str:
    """格式化文件大小"""
    if size_bytes < 1024:
        return f"{size_bytes} B"
    elif size_bytes < 1024 * 1024:
        return f"{size_bytes / 1024:.1f} KB"
    elif size_bytes < 1024 * 1024 * 1024:
        return f"{size_bytes / (1024 * 1024):.1f} MB"
    else:
        return f"{size_bytes / (1024 * 1024 * 1024):.1f} GB"
```

### 5. `core/converter.py` - 转换逻辑

```python
"""
Markdown 转换核心模块
"""

import os
import time
from typing import Callable, Optional
from core.file_handler import FileInfo

# Markdown 模板
TEMPLATES = {
    "默认": """# {relative_path}

```{language}
{content}
```

---

""",
    
    "详细信息": """## 📄 {basename}

**路径:** `{relative_path}`  
**语言:** {language}  
**大小:** {size}  
**修改时间:** {mtime}

```{language}
{content}
```

---

""",
    
    "GitHub 风格": """## {basename}

```{language}
{content}
```

<details>
<summary>📋 文件信息</summary>

- **完整路径:** `{relative_path}`
- **编程语言:** {language}
- **文件大小:** {size}
- **最后修改:** {mtime}

</details>

---

""",
    
    "简洁模式": """```{language}
// {relative_path}
{content}
```

""",
    
    "带目录": """### {relative_path}

<details open>
<summary>点击展开/折叠</summary>

```{language}
{content}
```

</details>

""",
    
    "专业文档": """## {basename}

> 📍 路径: `{relative_path}`  
> 🏷️ 语言: **{language}**  
> 📦 大小: {size}

```{language}
{content}
```

**最后修改:** {mtime}

---

"""
}

class Converter:
    """Markdown 转换器"""
    
    def __init__(self, template: str = "默认"):
        self.template = template
        self.base_path = os.getcwd()
    
    def set_template(self, template: str):
        """设置模板"""
        if template in TEMPLATES:
            self.template = template
    
    def set_base_path(self, path: str):
        """设置基准路径（用于计算相对路径）"""
        self.base_path = path
    
    def convert_file(self, file_info: FileInfo) -> str:
        """转换单个文件"""
        try:
            # 读取文件内容
            with open(file_info.path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # 准备模板变量
            basename = os.path.basename(file_info.path)
            
            try:
                relative_path = os.path.relpath(file_info.path, self.base_path)
            except ValueError:
                relative_path = file_info.path
            
            mtime = time.strftime(
                "%Y-%m-%d %H:%M:%S",
                time.localtime(os.path.getmtime(file_info.path))
            )
            
            from core.file_handler import format_size
            size = format_size(file_info.size)
            
            # 应用模板
            template = TEMPLATES.get(self.template, TEMPLATES["默认"])
            
            return template.format(
                basename=basename,
                relative_path=relative_path,
                language=file_info.language.lower(),
                size=size,
                mtime=mtime,
                content=content
            )
            
        except Exception as e:
            return f"<!-- ❌ 错误: 无法处理文件 {file_info.path}: {str(e)} -->\n\n"
    
    def convert_files(self, 
                     files: list[FileInfo],
                     output_path: str,
                     progress_callback: Optional[Callable[[int, int, str], None]] = None) -> dict:
        """
        批量转换文件
        
        Args:
            files: 文件列表
            output_path: 输出文件路径
            progress_callback: 进度回调函数 (current, total, filename)
        
        Returns:
            dict: 转换结果统计
        """
        total = len(files)
        success = 0
        errors = []
        
        try:
            with open(output_path, 'w', encoding='utf-8') as f:
                # 写入文档头部
                f.write(self._generate_header(files))
                
                # 转换每个文件
                for i, file_info in enumerate(files, 1):
                    try:
                        # 回调进度
                        if progress_callback:
                            progress_callback(i, total, file_info.name)
                        
                        # 转换并写入
                        markdown = self.convert_file(file_info)
                        f.write(markdown)
                        success += 1
                        
                    except Exception as e:
                        errors.append({
                            'file': file_info.path,
                            'error': str(e)
                        })
                
                # 写入文档尾部
                f.write(self._generate_footer(success, total))
        
        except Exception as e:
            return {
                'success': False,
                'message': f'写入输出文件失败: {str(e)}',
                'converted': 0,
                'total': total,
                'errors': errors
            }
        
        return {
            'success': True,
            'message': f'成功转换 {success}/{total} 个文件',
            'converted': success,
            'total': total,
            'errors': errors
        }
    
    def _generate_header(self, files: list[FileInfo]) -> str:
        """生成文档头部"""
        from core.file_handler import format_size
        
        total_size = sum(f.size for f in files)
        languages = set(f.language for f in files)
        
        header = f"""# 📚 Code to Markdown

**生成时间:** {time.strftime("%Y-%m-%d %H:%M:%S")}  
**文件数量:** {len(files)}  
**总大小:** {format_size(total_size)}  
**编程语言:** {', '.join(sorted(languages))}  
**使用模板:** {self.template}

---

"""
        return header
    
    def _generate_footer(self, success: int, total: int) -> str:
        """生成文档尾部"""
        footer = f"""

---

## 📊 转换统计

- ✅ 成功转换: **{success}** 个文件
- 📝 总计处理: **{total}** 个文件
- 🕐 完成时间: {time.strftime("%Y-%m-%d %H:%M:%S")}

---

*由 Code2Markdown 生成 - Material Design 3 版本*
"""
        return footer

def get_template_names() -> list[str]:
    """获取所有模板名称"""
    return list(TEMPLATES.keys())

def preview_template(template_name: str) -> str:
    """预览模板内容"""
    return TEMPLATES.get(template_name, TEMPLATES["默认"])
```

### 6. `ui/widgets/material_card.py` - Material 卡片组件

```python
"""
Material Design 卡片组件
"""

import customtkinter as ctk
from config.theme import MD

class MaterialCard(ctk.CTkFrame):
    """Material Design 卡片"""
    
    def __init__(self, master, elevation=1, **kwargs):
        # 根据高程选择背景色
        surface_colors = {
            0: MD.SURFACE,
            1: MD.SURFACE_1,
            2: MD.SURFACE_2,
            3: MD.SURFACE_3,
            4: MD.SURFACE_4,
            5: MD.SURFACE_5
        }
        
        fg_color = kwargs.pop('fg_color', surface_colors.get(elevation, MD.SURFACE_1))
        corner_radius = kwargs.pop('corner_radius', MD.RADIUS_MEDIUM)
        
        super().__init__(
            master,
            fg_color=fg_color,
            corner_radius=corner_radius,
            **kwargs
        )
        
        self.elevation = elevation

class MaterialButton(ctk.CTkButton):
    """Material Design 按钮"""
    
    STYLES = {
        'filled': {
            'fg_color': MD.PRIMARY,
            'hover_color': MD.PRIMARY_CONTAINER,
            'text_color': MD.ON_PRIMARY
        },
        'tonal': {
            'fg_color': MD.SECONDARY_CONTAINER,
            'hover_color': MD.SECONDARY,
            'text_color': MD.ON_SECONDARY_CONTAINER
        },
        'outlined': {
            'fg_color': 'transparent',
            'hover_color': MD.SURFACE_2,
            'text_color': MD.PRIMARY,
            'border_width': 1,
            'border_color': MD.OUTLINE
        },
        'text': {
            'fg_color': 'transparent',
            'hover_color': MD.SURFACE_2,
            'text_color': MD.PRIMARY
        },
        'error': {
            'fg_color': MD.ERROR,
            'hover_color': MD.ERROR_CONTAINER,
            'text_color': MD.ON_ERROR
        },
        'success': {
            'fg_color': MD.SUCCESS,
            'hover_color': MD.SUCCESS_CONTAINER,
            'text_color': MD.ON_PRIMARY
        }
    }
    
    def __init__(self, master, style='filled', **kwargs):
        style_props = self.STYLES.get(style, self.STYLES['filled']).copy()
        
        # 合并样式属性和用户属性
        for key, value in style_props.items():
            kwargs.setdefault(key, value)
        
        kwargs.setdefault('corner_radius', MD.RADIUS_LARGE)
        kwargs.setdefault('font', MD.FONT_LABEL)
        kwargs.setdefault('height', 40)
        
        super().__init__(master, **kwargs)

class MaterialEntry(ctk.CTkEntry):
    """Material Design 输入框"""
    
    def __init__(self, master, **kwargs):
        kwargs.setdefault('fg_color', MD.SURFACE_2)
        kwargs.setdefault('border_color', MD.OUTLINE)
        kwargs.setdefault('text_color', MD.ON_SURFACE)
        kwargs.setdefault('placeholder_text_color', MD.ON_SURFACE_VARIANT)
        kwargs.setdefault('corner_radius', MD.RADIUS_SMALL)
        kwargs.setdefault('font', MD.FONT_BODY)
        kwargs.setdefault('height', 40)
        
        super().__init__(master, **kwargs)

class StatCard(MaterialCard):
    """统计卡片组件"""
    
    def __init__(self, master, icon: str, label: str, value: str = "0", **kwargs):
        super().__init__(master, elevation=0, **kwargs)
        
        self.configure(fg_color=MD.SURFACE_2)
        
        # 内边距容器
        container = ctk.CTkFrame(self, fg_color='transparent')
        container.pack(fill='both', expand=True, padx=MD.SPACING_SM, pady=MD.SPACING_SM)
        
        # 图标
        self.icon_label = ctk.CTkLabel(
            container,
            text=icon,
            font=("Segoe UI Emoji", 20),
            text_color=MD.PRIMARY
        )
        self.icon_label.pack(anchor='w')
        
        # 数值
        self.value_label = ctk.CTkLabel(
            container,
            text=value,
            font=MD.FONT_TITLE,
            text_color=MD.ON_SURFACE
        )
        self.value_label.pack(anchor='w', pady=(MD.SPACING_XS, 0))
        
        # 标签
        self.label_label = ctk.CTkLabel(
            container,
            text=label,
            font=MD.FONT_LABEL,
            text_color=MD.ON_SURFACE_VARIANT
        )
        self.label_label.pack(anchor='w')
    
    def update_value(self, value: str):
        """更新数值"""
        self.value_label.configure(text=value)
```

### 7. `ui/components/file_list_panel.py` - 文件列表面板

```python
"""
文件列表面板组件
"""

import customtkinter as ctk
import tkinter as tk
from tkinter import filedialog
from config.theme import MD
from ui.widgets.material_card import MaterialCard, MaterialButton, MaterialEntry
from core.file_handler import FileHandler, get_all_languages, format_size

class FileListPanel(MaterialCard):
    """文件列表面板"""
    
    def __init__(self, master, file_handler: FileHandler, **kwargs):
        super().__init__(master, elevation=1, **kwargs)
        
        self.file_handler = file_handler
        self.on_update_callback = None
        
        self._build_ui()
    
    def _build_ui(self):
        """构建UI"""
        # 主容器
        container = ctk.CTkFrame(self, fg_color='transparent')
        container.pack(fill='both', expand=True, padx=MD.SPACING_MD, pady=MD.SPACING_MD)
        
        # 标题栏
        self._build_header(container)
        
        # 搜索和筛选栏
        self._build_search_bar(container)
        
        # 操作按钮栏
        self._build_action_bar(container)
        
        # 文件列表
        self._build_file_list(container)
        
        # 底部统计
        self._build_footer(container)
    
    def _build_header(self, parent):
        """构建标题栏"""
        header = ctk.CTkFrame(parent, fg_color='transparent')
        header.pack(fill='x', pady=(0, MD.SPACING_MD))
        
        # 标题
        title_container = ctk.CTkFrame(header, fg_color='transparent')
        title_container.pack(side='left')
        
        ctk.CTkLabel(
            title_container,
            text="文件管理",
            font=MD.FONT_HEADLINE,
            text_color=MD.ON_SURFACE
        ).pack(side='left')
        
        ctk.CTkLabel(
            title_container,
            text="📁",
            font=("Segoe UI Emoji", 24)
        ).pack(side='left', padx=(MD.SPACING_SM, 0))
    
    def _build_search_bar(self, parent):
        """构建搜索栏"""
        search_bar = ctk.CTkFrame(parent, fg_color='transparent')
        search_bar.pack(fill='x', pady=(0, MD.SPACING_MD))
        
        # 搜索框
        self.search_var = tk.StringVar()
        self.search_var.trace('w', lambda *args: self._filter_files())
        
        search_entry = MaterialEntry(
            search_bar,
            textvariable=self.search_var,
            placeholder_text="🔍 搜索文件名...",
            width=300
        )
        search_entry.pack(side='left', fill='x', expand=True, padx=(0, MD.SPACING_SM))
        
        # 语言筛选
        self.language_var = tk.StringVar(value="全部语言")
        self.language_var.trace('w', lambda *args: self._filter_files())
        
        languages = ["全部语言"] + get_all_languages()
        language_combo = ctk.CTkComboBox(
            search_bar,
            values=languages,
            variable=self.language_var,
            state='readonly',
            width=150,
            fg_color=MD.SURFACE_2,
            button_color=MD.PRIMARY,
            border_color=MD.OUTLINE,
            font=MD.FONT_BODY
        )
        language_combo.pack(side='left')
    
    def _build_action_bar(self, parent):
        """构建操作按钮栏"""
        action_bar = ctk.CTkFrame(parent, fg_color='transparent')
        action_bar.pack(fill='x', pady=(0, MD.SPACING_MD))
        
        # 左侧按钮
        left_buttons = ctk.CTkFrame(action_bar, fg_color='transparent')
        left_buttons.pack(side='left')
        
        MaterialButton(
            left_buttons,
            text="📄 添加文件",
            command=self._add_files,
            style='filled',
            width=120
        ).pack(side='left', padx=(0, MD.SPACING_SM))
        
        MaterialButton(
            left_buttons,
            text="📁 添加文件夹",
            command=self._add_folder,
            style='tonal',
            width=120
        ).pack(side='left', padx=(0, MD.SPACING_SM))
        
        MaterialButton(
            left_buttons,
            text="🗑️ 清空",
            command=self._clear_files,
            style='error',
            width=100
        ).pack(side='left')
        
        # 右侧按钮
        right_buttons = ctk.CTkFrame(action_bar, fg_color='transparent')
        right_buttons.pack(side='right')
        
        MaterialButton(
            right_buttons,
            text="全选",
            command=lambda: self._mark_all(True),
            style='outlined',
            width=80
        ).pack(side='left', padx=(0, MD.SPACING_SM))
        
        MaterialButton(
            right_buttons,
            text="全不选",
            command=lambda: self._mark_all(False),
            style='outlined',
            width=80
        ).pack(side='left')
    
    def _build_file_list(self, parent):
        """构建文件列表"""
        # 列表容器
        list_container = ctk.CTkFrame(parent, fg_color=MD.SURFACE)
        list_container.pack(fill='both', expand=True, pady=(0, MD.SPACING_MD))
        
        # 文本框
        self.file_textbox = ctk.CTkTextbox(
            list_container,
            font=MD.FONT_MONO,
            fg_color=MD.SURFACE,
            text_color=MD.ON_SURFACE,
            wrap='none'
        )
        self.file_textbox.pack(fill='both', expand=True)
        
        # 绑定事件
        self.file_textbox.bind('<Button-1>', self._on_file_click)
        self.file_textbox.bind('<space>', lambda e: self._toggle_current_mark())
    
    def _build_footer(self, parent):
        """构建底部统计"""
        footer = ctk.CTkFrame(parent, fg_color='transparent')
        footer.pack(fill='x')
        
        self.stats_label = ctk.CTkLabel(
            footer,
            text="0 个文件",
            font=MD.FONT_BODY,
            text_color=MD.ON_SURFACE_VARIANT
        )
        self.stats_label.pack(side='left')
    
    # 事件处理
    def _add_files(self):
        """添加文件"""
        filetypes = [
            ("所有支持的文件", "*.py *.js *.java *.cpp *.html *.css"),
            ("所有文件", "*.*")
        ]
        
        files = filedialog.askopenfilenames(title="选择代码文件", filetypes=filetypes)
        
        if files:
            count = self.file_handler.add_files(list(files))
            self.refresh()
            
            if self.on_update_callback:
                self.on_update_callback(f"✅ 添加了 {count} 个文件", 'success')
    
    def _add_folder(self):
        """添加文件夹"""
        folder = filedialog.askdirectory(title="选择文件夹")
        
        if folder:
            count = self.file_handler.add_folder(folder)
            self.refresh()
            
            if self.on_update_callback:
                self.on_update_callback(f"✅ 从文件夹添加了 {count} 个文件", 'success')
    
    def _clear_files(self):
        """清空文件"""
        if not self.file_handler.files:
            return
        
        # 简化版确认（可以后续替换为自定义对话框）
        from tkinter import messagebox
        if messagebox.askyesno("确认清空", "确定要清空所有文件吗？"):
            self.file_handler.clear()
            self.refresh()
            
            if self.on_update_callback:
                self.on_update_callback("🗑️ 已清空文件列表", 'info')
    
    def _mark_all(self, marked: bool):
        """全选/全不选"""
        self.file_handler.mark_all(marked)
        self.refresh()
        
        if self.on_update_callback:
            msg = "✅ 已全选" if marked else "⬜ 已取消全选"
            self.on_update_callback(msg, 'info')
    
    def _filter_files(self):
        """筛选文件"""
        search = self.search_var.get()
        language = self.language_var.get()
        
        filtered = self.file_handler.filter_files(
            search=search if search else None,
            language=language if language != "全部语言" else None
        )
        
        self._display_files(filtered)
    
    def _on_file_click(self, event):
        """文件点击事件"""
        # 获取点击位置的行
        index = self.file_textbox.index(f"@{event.x},{event.y}")
        line_num = int(index.split('.')[0])
        
        # 获取该行内容
        line_start = f"{line_num}.0"
        line_end = f"{line_num}.end"
        line_content = self.file_textbox.get(line_start, line_end)
        
        # 解析文件名并切换标记
        if line_content.strip():
            parts = line_content.strip().split('│')
            if len(parts) >= 2:
                filename = parts[1].strip().lstrip('✓ ').lstrip('☐ ')
                
                # 找到对应文件并切换标记
                for file_info in self.file_handler.files:
                    if file_info.name == filename:
                        self.file_handler.toggle_mark(file_info.path)
                        self.refresh()
                        break
    
    def _toggle_current_mark(self):
        """切换当前行的标记状态"""
        cursor_pos = self.file_textbox.index(tk.INSERT)
        line_num = int(cursor_pos.split('.')[0])
        
        line_start = f"{line_num}.0"
        line_end = f"{line_num}.end"
        line_content = self.file_textbox.get(line_start, line_end)
        
        if line_content.strip():
            parts = line_content.strip().split('│')
            if len(parts) >= 2:
                filename = parts[1].strip().lstrip('✓ ').lstrip('☐ ')
                
                for file_info in self.file_handler.files:
                    if file_info.name == filename:
                        self.file_handler.toggle_mark(file_info.path)
                        self.refresh()
                        break
    
    def _display_files(self, files):
        """显示文件列表"""
        self.file_textbox.delete('1.0', 'end')
        
        if not files:
            self.file_textbox.insert('end', '\n  暂无文件\n\n  点击上方按钮添加文件或文件夹')
            return
        
        # 表头
        header = f"{'状态':^6}│ {'文件名':<40} │ {'语言':<15} │ {'大小':<10}\n"
        separator = "─" * 80 + "\n"
        
        self.file_textbox.insert('end', header)
        self.file_textbox.insert('end', separator)
        
        # 文件列表
        for file_info in files:
            icon = "✓" if file_info.marked else "☐"
            name = file_info.name[:38] + '..' if len(file_info.name) > 40 else file_info.name
            language = file_info.language
            size = format_size(file_info.size)
            
            line = f"  {icon:^4}│ {name:<40} │ {language:<15} │ {size:<10}\n"
            self.file_textbox.insert('end', line)
    
    def refresh(self):
        """刷新显示"""
        self._filter_files()
        
        # 更新统计
        stats = self.file_handler.get_stats()
        self.stats_label.configure(
            text=f"{stats['marked']}/{stats['total']} 个文件已选中  •  "
                 f"共 {format_size(stats['size'])}  •  "
                 f"{stats['languages']} 种语言"
        )
    
    def set_update_callback(self, callback):
        """设置更新回调"""
        self.on_update_callback = callback
```

### 8. `ui/components/control_panel.py` - 控制面板

```python
"""
控制面板组件
"""

import customtkinter as ctk
import tkinter as tk
from config.theme import MD
from ui.widgets.material_card import MaterialCard, MaterialButton, StatCard
from core.converter import get_template_names, Converter
from core.file_handler import FileHandler, format_size

class ControlPanel(MaterialCard):
    """控制面板"""
    
    def __init__(self, master, file_handler: FileHandler, **kwargs):
        super().__init__(master, elevation=1, **kwargs)
        
        self.file_handler = file_handler
        self.converter = Converter()
        
        self.on_preview_callback = None
        self.on_convert_callback = None
        
        self._build_ui()
    
    def _build_ui(self):
        """构建UI"""
        container = ctk.CTkFrame(self, fg_color='transparent')
        container.pack(fill='both', expand=True, padx=MD.SPACING_MD, pady=MD.SPACING_MD)
        
        # 标题
        self._build_header(container)
        
        # 模板选择
        self._build_template_section(container)
        
        # 统计卡片
        self._build_stats_section(container)
        
        # 操作按钮
        self._build_actions(container)
        
        # 进度显示
        self._build_progress(container)
    
    def _build_header(self, parent):
        """构建标题"""
        header = ctk.CTkFrame(parent, fg_color='transparent')
        header.pack(fill='x', pady=(0, MD.SPACING_LG))
        
        title_container = ctk.CTkFrame(header, fg_color='transparent')
        title_container.pack(anchor='w')
        
        ctk.CTkLabel(
            title_container,
            text="转换设置",
            font=MD.FONT_HEADLINE,
            text_color=MD.ON_SURFACE
        ).pack(side='left')
        
        ctk.CTkLabel(
            title_container,
            text="⚙️",
            font=("Segoe UI Emoji", 24)
        ).pack(side='left', padx=(MD.SPACING_SM, 0))
    
    def _build_template_section(self, parent):
        """构建模板选择区域"""
        section = MaterialCard(parent, elevation=0, fg_color=MD.SURFACE_2)
        section.pack(fill='x', pady=(0, MD.SPACING_MD))
        
        section_container = ctk.CTkFrame(section, fg_color='transparent')
        section_container.pack(fill='both', padx=MD.SPACING_MD, pady=MD.SPACING_MD)
        
        # 标题
        ctk.CTkLabel(
            section_container,
            text="Markdown 模板",
            font=MD.FONT_TITLE,
            text_color=MD.ON_SURFACE,
            anchor='w'
        ).pack(fill='x', pady=(0, MD.SPACING_SM))
        
        # 模板选择下拉框
        self.template_var = tk.StringVar(value="默认")
        template_combo = ctk.CTkComboBox(
            section_container,
            values=get_template_names(),
            variable=self.template_var,
            state='readonly',
            fg_color=MD.SURFACE,
            button_color=MD.PRIMARY,
            border_color=MD.OUTLINE,
            font=MD.FONT_BODY,
            command=self._on_template_changed
        )
        template_combo.pack(fill='x', pady=(0, MD.SPACING_SM))
        
        # 预览按钮
        MaterialButton(
            section_container,
            text="👁️ 预览模板",
            command=self._preview_template,
            style='outlined',
            width=200
        ).pack(fill='x')
    
    def _build_stats_section(self, parent):
        """构建统计区域"""
        # 区域标题
        ctk.CTkLabel(
            parent,
            text="📊 统计信息",
            font=MD.FONT_TITLE,
            text_color=MD.ON_SURFACE,
            anchor='w'
        ).pack(fill='x', pady=(MD.SPACING_MD, MD.SPACING_SM))
        
        # 统计卡片网格
        stats_grid = ctk.CTkFrame(parent, fg_color='transparent')
        stats_grid.pack(fill='x', pady=(0, MD.SPACING_MD))
        
        stats_grid.grid_columnconfigure(0, weight=1)
        stats_grid.grid_columnconfigure(1, weight=1)
        
        # 创建统计卡片
        self.stat_cards = {
            'total': StatCard(stats_grid, "📄", "总文件", "0"),
            'marked': StatCard(stats_grid, "✅", "已选中", "0"),
            'size': StatCard(stats_grid, "💾", "总大小", "0 B"),
            'languages': StatCard(stats_grid, "🏷️", "语言数", "0")
        }
        
        self.stat_cards['total'].grid(row=0, column=0, sticky='ew', padx=(0, MD.SPACING_XS), pady=(0, MD.SPACING_XS))
        self.stat_cards['marked'].grid(row=0, column=1, sticky='ew', padx=(MD.SPACING_XS, 0), pady=(0, MD.SPACING_XS))
        self.stat_cards['size'].grid(row=1, column=0, sticky='ew', padx=(0, MD.SPACING_XS), pady=(MD.SPACING_XS, 0))
        self.stat_cards['languages'].grid(row=1, column=1, sticky='ew', padx=(MD.SPACING_XS, 0), pady=(MD.SPACING_XS, 0))
    
    def _build_actions(self, parent):
        """构建操作按钮"""
        actions = ctk.CTkFrame(parent, fg_color='transparent')
        actions.pack(fill='x', pady=(MD.SPACING_LG, 0))
        
        MaterialButton(
            actions,
            text="👁️ 预览转换结果",
            command=self._preview_conversion,
            style='tonal',
            height=48
        ).pack(fill='x', pady=(0, MD.SPACING_SM))
        
        MaterialButton(
            actions,
            text="🚀 开始转换",
            command=self._start_conversion,
            style='success',
            height=56,
            font=MD.FONT_BODY_LARGE
        ).pack(fill='x')
    
    def _build_progress(self, parent):
        """构建进度显示"""
        self.progress_container = ctk.CTkFrame(parent, fg_color='transparent')
        self.progress_container.pack(fill='x', pady=(MD.SPACING_MD, 0))
        
        self.progress_bar = ctk.CTkProgressBar(
            self.progress_container,
            height=8,
            corner_radius=4,
            fg_color=MD.SURFACE_2,
            progress_color=MD.PRIMARY
        )
        
        self.progress_label = ctk.CTkLabel(
            self.progress_container,
            text="",
            font=MD.FONT_LABEL,
            text_color=MD.ON_SURFACE_VARIANT
        )
        
        # 初始隐藏
        self.hide_progress()
    
    # 事件处理
    def _on_template_changed(self, template_name):
        """模板改变事件"""
        self.converter.set_template(template_name)
    
    def _preview_template(self):
        """预览模板"""
        if self.on_preview_callback:
            self.on_preview_callback('template', self.template_var.get())
    
    def _preview_conversion(self):
        """预览转换"""
        marked_files = self.file_handler.get_marked_files()
        
        if not marked_files:
            if self.on_preview_callback:
                self.on_preview_callback('warning', '请先选择要预览的文件')
            return
        
        if self.on_preview_callback:
            self.on_preview_callback('conversion', marked_files)
    
    def _start_conversion(self):
        """开始转换"""
        marked_files = self.file_handler.get_marked_files()
        
        if not marked_files:
            if self.on_convert_callback:
                self.on_convert_callback('warning', '请先选择要转换的文件')
            return
        
        if self.on_convert_callback:
            self.on_convert_callback('start', marked_files)
    
    def update_stats(self):
        """更新统计信息"""
        stats = self.file_handler.get_stats()
        
        self.stat_cards['total'].update_value(str(stats['total']))
        self.stat_cards['marked'].update_value(str(stats['marked']))
        self.stat_cards['size'].update_value(format_size(stats['size']))
        self.stat_cards['languages'].update_value(str(stats['languages']))
    
    def show_progress(self):
        """显示进度条"""
        self.progress_bar.pack(fill='x', pady=(0, MD.SPACING_SM))
        self.progress_label.pack()
        self.progress_bar.set(0)
    
    def hide_progress(self):
        """隐藏进度条"""
        self.progress_bar.pack_forget()
        self.progress_label.pack_forget()
    
    def update_progress(self, current: int, total: int, filename: str = ""):
        """更新进度"""
        progress = current / total if total > 0 else 0
        self.progress_bar.set(progress)
        self.progress_label.configure(
            text=f"正在处理: {filename} ({current}/{total})"
        )
    
    def set_preview_callback(self, callback):
        """设置预览回调"""
        self.on_preview_callback = callback
    
    def set_convert_callback(self, callback):
        """设置转换回调"""
        self.on_convert_callback = callback
    
    def get_template(self) -> str:
        """获取当前模板"""
        return self.template_var.get()
```

### 9. `ui/components/dialogs.py` - 对话框组件

```python
"""
对话框组件
"""

import customtkinter as ctk
from config.theme import MD
from ui.widgets.material_card import MaterialButton
from core.converter import preview_template, Converter
from core.file_handler import FileInfo

class PreviewDialog(ctk.CTkToplevel):
    """预览对话框基类"""
    
    def __init__(self, parent, title: str, width: int = 800, height: int = 600):
        super().__init__(parent)
        
        self.title(title)
        self.geometry(f"{width}x{height}")
        self.configure(fg_color=MD.BACKGROUND)
        
        # 居中显示
        self.update_idletasks()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f"{width}x{height}+{x}+{y}")
        
        # 模态
        self.transient(parent)
        self.grab_set()
    
    def _build_header(self, title: str, subtitle: str = ""):
        """构建头部"""
        header = ctk.CTkFrame(self, fg_color=MD.SURFACE_1, height=80)
        header.pack(fill='x', padx=MD.SPACING_LG, pady=MD.SPACING_LG)
        header.pack_propagate(False)
        
        header_content = ctk.CTkFrame(header, fg_color='transparent')
        header_content.pack(fill='both', expand=True, padx=MD.SPACING_MD, pady=MD.SPACING_MD)
        
        ctk.CTkLabel(
            header_content,
            text=title,
            font=MD.FONT_HEADLINE,
            text_color=MD.ON_SURFACE
        ).pack(anchor='w')
        
        if subtitle:
            ctk.CTkLabel(
                header_content,
                text=subtitle,
                font=MD.FONT_BODY,
                text_color=MD.ON_SURFACE_VARIANT
            ).pack(anchor='w', pady=(MD.SPACING_XS, 0))
        
        return header
    
    def _build_content_area(self):
        """构建内容区域"""
        content = ctk.CTkFrame(self, fg_color=MD.SURFACE)
        content.pack(fill='both', expand=True, padx=MD.SPACING_LG, pady=(0, MD.SPACING_LG))
        
        textbox = ctk.CTkTextbox(
            content,
            font=MD.FONT_MONO,
            fg_color=MD.SURFACE,
            text_color=MD.ON_SURFACE,
            wrap='none'
        )
        textbox.pack(fill='both', expand=True, padx=MD.SPACING_MD, pady=MD.SPACING_MD)
        
        return textbox
    
    def _build_footer(self):
        """构建底部按钮"""
        footer = ctk.CTkFrame(self, fg_color='transparent')
        footer.pack(fill='x', padx=MD.SPACING_LG, pady=(0, MD.SPACING_LG))
        
        MaterialButton(
            footer,
            text="关闭",
            command=self.destroy,
            style='text',
            width=120
        ).pack(side='right')
        
        return footer

class TemplatePreviewDialog(PreviewDialog):
    """模板预览对话框"""
    
    def __init__(self, parent, template_name: str):
        super().__init__(parent, f"模板预览 - {template_name}", 700, 500)
        
        self._build_header(
            f"📋 {template_name} 模板",
            "查看模板的格式和结构"
        )
        
        textbox = self._build_content_area()
        
        # 显示模板内容
        template_content = preview_template(template_name)
        textbox.insert('1.0', template_content)
        textbox.configure(state='disabled')
        
        self._build_footer()

class ConversionPreviewDialog(PreviewDialog):
    """转换预览对话框"""
    
    def __init__(self, parent, files: list[FileInfo], template: str, max_files: int = 5):
        super().__init__(parent, "转换预览", 900, 700)
        
        self._build_header(
            f"👁️ 转换预览",
            f"使用 {template} 模板  •  预览前 {min(len(files), max_files)} 个文件"
        )
        
        textbox = self._build_content_area()
        
        # 生成预览内容
        converter = Converter(template)
        preview_content = []
        
        for i, file_info in enumerate(files[:max_files]):
            preview_content.append(converter.convert_file(file_info))
        
        if len(files) > max_files:
            preview_content.append(
                f"\n{'='*80}\n"
                f"... 还有 {len(files) - max_files} 个文件未在预览中显示 ...\n"
                f"{'='*80}\n"
            )
        
        textbox.insert('1.0', ''.join(preview_content))
        textbox.configure(state='disabled')
        
        self._build_footer()
```

### 10. `ui/app.py` - 主应用窗口

```python
"""
主应用窗口
"""

import customtkinter as ctk
from tkinter import filedialog, messagebox
import os

from config.theme import MD
from config.settings import Settings
from core.file_handler import FileHandler
from core.converter import Converter
from ui.components.file_list_panel import FileListPanel
from ui.components.control_panel import ControlPanel
from ui.components.dialogs import TemplatePreviewDialog, ConversionPreviewDialog

class MaterialApp(ctk.CTk):
    """主应用程序"""
    
    def __init__(self):
        super().__init__()
        
        # 初始化
        self.settings = Settings()
        self.file_handler = FileHandler()
        self.converter = Converter()
        
        self._setup_window()
        self._build_ui()
        self._load_saved_state()
        
        # 绑定关闭事件
        self.protocol("WM_DELETE_WINDOW", self._on_closing)
    
    def _setup_window(self):
        """设置窗口"""
        self.title("Code2Markdown - Material Design 3")
        
        # 窗口大小
        width = self.settings.get('window', {}).get('width', 1280)
        height = self.settings.get('window', {}).get('height', 800)
        
        # 居中显示
        screen_width = self.winfo_screenwidth()
        screen_height = self.winfo_screenheight()
        x = (screen_width - width) // 2
        y = (screen_height - height) // 2
        
        self.geometry(f"{width}x{height}+{x}+{y}")
        
        # 最小尺寸
        min_width = self.settings.get('window', {}).get('min_width', 1000)
        min_height = self.settings.get('window', {}).get('min_height', 600)
        self.minsize(min_width, min_height)
        
        # 背景色
        self.configure(fg_color=MD.BACKGROUND)
    
    def _build_ui(self):
        """构建UI"""
        # 配置网格
        self.grid_columnconfigure(0, weight=3)
        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(0, weight=1)
        
        # 文件列表面板
        self.file_panel = FileListPanel(self, self.file_handler)
        self.file_panel.grid(row=0, column=0, sticky='nsew', 
                           padx=(MD.SPACING_LG, MD.SPACING_SM), 
                           pady=MD.SPACING_LG)
        
        # 控制面板
        self.control_panel = ControlPanel(self, self.file_handler)
        self.control_panel.grid(row=0, column=1, sticky='nsew',
                              padx=(MD.SPACING_SM, MD.SPACING_LG),
                              pady=MD.SPACING_LG)
        
        # 设置回调
        self.file_panel.set_update_callback(self._on_file_update)
        self.control_panel.set_preview_callback(self._on_preview)
        self.control_panel.set_convert_callback(self._on_convert)
        
        # 创建通知标签（初始隐藏）
        self.toast_label = None
    
    def _on_file_update(self, message: str, type: str = 'info'):
        """文件更新回调"""
        self.control_panel.update_stats()
        self._show_toast(message, type)
    
    def _on_preview(self, preview_type: str, data):
        """预览回调"""
        if preview_type == 'template':
            TemplatePreviewDialog(self, data)
        
        elif preview_type == 'conversion':
            template = self.control_panel.get_template()
            max_files = self.settings.get('preview_max_files', 5)
            ConversionPreviewDialog(self, data, template, max_files)
        
        elif preview_type == 'warning':
            self._show_toast(f"⚠️ {data}", 'warning')
    
    def _on_convert(self, action: str, data):
        """转换回调"""
        if action == 'warning':
            self._show_toast(f"⚠️ {data}", 'warning')
            return
        
        if action == 'start':
            self._perform_conversion(data)
    
    def _perform_conversion(self, files):
        """执行转换"""
        # 选择保存位置
        output_file = filedialog.asksaveasfilename(
            title="保存 Markdown 文件",
            defaultextension=".md",
            filetypes=[("Markdown 文件", "*.md"), ("所有文件", "*.*")]
        )
        
        if not output_file:
            return
        
        # 显示进度
        self.control_panel.show_progress()
        
        # 设置转换器
        template = self.control_panel.get_template()
        self.converter.set_template(template)
        
        # 进度回调
        def progress_callback(current, total, filename):
            self.control_panel.update_progress(current, total, filename)
            self.update_idletasks()
        
        # 执行转换
        result = self.converter.convert_files(files, output_file, progress_callback)
        
        # 隐藏进度
        self.after(1000, self.control_panel.hide_progress)
        
        # 显示结果
        if result['success']:
            self._show_toast(f"✅ {result['message']}", 'success')
            messagebox.showinfo(
                "转换完成",
                f"{result['message']}\n\n保存位置: {output_file}"
            )
        else:
            self._show_toast(f"❌ {result['message']}", 'error')
            messagebox.showerror("转换失败", result['message'])
    
    def _show_toast(self, message: str, type: str = 'info'):
        """显示通知消息"""
        # 颜色映射
        colors = {
            'success': MD.SUCCESS,
            'error': MD.ERROR,
            'warning': MD.WARNING,
            'info': MD.INFO
        }
        
        color = colors.get(type, MD.INFO)
        
        # 创建通知标签
        if self.toast_label:
            self.toast_label.destroy()
        
        self.toast_label = ctk.CTkLabel(
            self,
            text=message,
            font=MD.FONT_BODY,
            fg_color=color,
            text_color=MD.ON_PRIMARY,
            corner_radius=MD.RADIUS_MEDIUM,
            height=48
        )
        
        # 定位
        self.toast_label.place(relx=0.5, rely=0.92, anchor='center')
        
        # 自动消失
        self.after(3000, lambda: self.toast_label.destroy() if self.toast_label else None)
    
    def _load_saved_state(self):
        """加载保存的状态"""
        # 加载最近文件
        recent_files = self.settings.get('recent_files', [])
        for file_path in recent_files:
            if os.path.exists(file_path):
                self.file_handler.add_file(file_path)
        
        # 刷新显示
        self.file_panel.refresh()
        self.control_panel.update_stats()
    
    def _save_state(self):
        """保存状态"""
        # 保存窗口大小
        geometry = self.geometry().split('+')[0]  # 只取尺寸部分
        width, height = map(int, geometry.split('x'))
        
        self.settings.set('window', {
            'width': width,
            'height': height,
            'min_width': 1000,
            'min_height': 600
        })
        
        # 保存文件列表
        max_recent = self.settings.get('max_recent_files', 50)
        recent_files = [f.path for f in self.file_handler.files[:max_recent]]
        self.settings.set('recent_files', recent_files)
        
        # 保存模板选择
        self.settings.set('template', self.control_panel.get_template())
        
        # 保存配置
        self.settings.save()
    
    def _on_closing(self):
        """关闭窗口"""
        if self.settings.get('auto_save_config', True):
            self._save_state()
        
        self.destroy()
```

### 11. `utils/helpers.py` - 辅助函数

```python
"""
辅助工具函数
"""

import os
from typing import Optional

def get_relative_path(file_path: str, base_path: Optional[str] = None) -> str:
    """获取相对路径"""
    if base_path is None:
        base_path = os.getcwd()
    
    try:
        return os.path.relpath(file_path, base_path)
    except ValueError:
        return file_path

def truncate_string(s: str, max_length: int, suffix: str = '...') -> str:
    """截断字符串"""
    if len(s) <= max_length:
        return s
    return s[:max_length - len(suffix)] + suffix

def validate_file_path(path: str) -> bool:
    """验证文件路径"""
    return os.path.isfile(path) and os.path.exists(path)
```

### 12. `config/__init__.py` 和其他 `__init__.py`

```python
# 所有 __init__.py 文件内容
"""
Package initialization
"""
```

---

## 🎨 Material Design 3 改进点

1. **颜色系统**
   - 采用 Material You 配色方案
   - Primary、Secondary、Tertiary 三级色彩
   - Surface 高程系统（5个层级）

2. **组件设计**
   - MaterialCard - 支持不同高程
   - MaterialButton - 5种风格（filled, tonal, outlined, text, error）
   - StatCard - 精美的统计卡片
   - 统一的圆角和间距

3. **交互体验**
   - Toast 通知系统
   - 模态对话框
   - 进度反馈
   - 流畅的状态更新

4. **模块化架构**
   - 清晰的职责分离
   - 易于维护和扩展
   - 配置与代码分离

## 🚀 使用方法

```bash
# 安装依赖
pip install customtkinter

# 运行应用
python main.py
```

这个重构版本更加现代、专业，符合 Material Design 3 规范！🎉